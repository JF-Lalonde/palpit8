$(document).on('turbolinks:load', function() {
  submitNewMessage();
});

<% Chatroom.all.each do |chatroom| %>

App['room' + <%=chatroom.id%>] = App.cable.subscriptions.create({channel: 'MessagesChannel', room: <%=chatroom.id%>}, {
  received: function(data) {
    $("[data-chatroom='" + this.chatroomId + "']").removeClass('hidden').scrollTop($("[data-chatroom]")[0].scrollHeight)
      return $("[data-chatroom='" + this.chatroomId + "']").append(data.message);
  },

  setChatroomId: function(chatroomId) {
    this.chatroomId = chatroomId
  }
});
<% end %>

function submitNewMessage(){
  $('[data-send]').click(function() {
      var msg = $('[data-textarea]').val()
        var chatroomId = $("[data-chatroom]").data().chatroom
        App['room' + chatroomId].setChatroomId(chatroomId)
        App['room' + chatroomId].send({message: msg})
        $('[data-textarea="message"]').val("")
        return false;
  });
}
